#!/usr/bin/env python3

# Removes file from index OR from curr directory AND index 

import sys
import os 
import filecmp

args = sys.argv[1:]
index_path = '.mite/index'
commits_dir = '.mite/commits'
options = set()
filenames = []

# If cached and force remove options exist in argument
for arg in args:
    if arg == '--cached' or arg == '--force':
        options.add(arg)
    # Else if no options, only attach filenames for our arguments
    else:
        filenames.append(arg)


if not os.path.isdir(index_path):
    sys.exit(1)

def get_latest_commit_file(filename):
    try:
        if not os.path.exists(commits_dir):
            return None
        
        # Get all numbered commit directories and find the highest
        commit_nums = [int(d) for d in os.listdir(commits_dir) if d.isdigit()]
        if not commit_nums:
            return None
            
        latest_commit = max(commit_nums)
        commit_file_path = f'{commits_dir}/{latest_commit}/{filename}'
        return commit_file_path if os.path.exists(commit_file_path) else None
    except:
        return None

def files_are_same(file1, file2):
    if not os.path.exists(file1) or not os.path.exists(file2):
        return False
    return filecmp.cmp(file1, file2, shallow=False)


if '--cached' in options:
    for filename in filenames:
        index_file_path = os.path.join(index_path, filename)
        latest_commit_path = get_latest_commit_file(filename)
        
        # Check if file exists in mite at all (index OR commits)
        if not os.path.exists(index_file_path) and latest_commit_path is None:
            print(f"mite-rm: error: '{filename}' is not in the mite repository")
            continue
        
        # Only perform safety checks if --force is NOT present
        if '--force' not in options:
            if (os.path.exists(index_file_path) and os.path.exists(filename) and latest_commit_path):
                # Check if index differs from both working and repo
                index_vs_working = not files_are_same(index_file_path, filename)
                index_vs_commit = not files_are_same(index_file_path, latest_commit_path)
                
                if index_vs_working and index_vs_commit:
                    print(f"mite-rm: error: '{filename}' in index is different to both the working file and the repository")
                    continue
        
        # If we get here, we safely remove from the index
        if os.path.exists(index_file_path):
            os.remove(index_file_path)


if '--force' in options and '--cached' not in options:
    for filename in filenames:
        index_file_path = os.path.join(index_path, filename)
        in_index = os.path.exists(index_file_path)
        
        # Can't force remove files that aren't in index
        if not in_index:
            print(f"mite-rm: error: '{filename}' is not in the mite repository")
            continue
        
        # If file is in index or working_dir, remove them
        if in_index:
            os.remove(index_file_path)
        if os.path.exists(filename):
            os.remove(filename)


if '--cached' not in options and '--force' not in options:
    for filename in filenames:
        index_file_path = os.path.join(index_path, filename)
        latest_commit_path = get_latest_commit_file(filename)
        in_index = os.path.exists(index_file_path)
        in_working_dir = os.path.exists(filename)
        in_latest_commit = latest_commit_path is not None
        
        # Check if file does not exist in index or latest commit, dont't remove
        if not in_index and not in_latest_commit:
            print(f"mite-rm: error: '{filename}' is not in the mite repository")
            continue

        # Check if index differs from both working and latest commit
        if in_index and in_working_dir and in_latest_commit:
            index_vs_working = not files_are_same(index_file_path, filename)
            index_vs_commit = not files_are_same(index_file_path, latest_commit_path)

            # If the index is not the same as the latest commit or working_dir file            
            if index_vs_working and index_vs_commit:
                """
                # Prevent removing file if index holds unique changes not
                present in working dir or repo 
                """
                print(f"mite-rm: error: '{filename}' in index is different to both the working file and the repository")
                continue

        # Check if file has staged changes (index differs from the latest commit)
        if in_index and in_latest_commit:
            if not files_are_same(index_file_path, latest_commit_path):
                print(f"mite-rm: error: '{filename}' has staged changes in the index")
                continue

        # Check if working file differs from latest commit
        if in_working_dir and in_latest_commit:
            if not files_are_same(filename, latest_commit_path):
                print(f"mite-rm: error: '{filename}' in the repository is different to the working file")
                continue

        # Check if file only exists in index
        if in_index and not in_latest_commit:
            print(f"mite-rm: error: '{filename}' has staged changes in the index")
            continue
                
        # If we pass all the above, then we can safely remove
        if in_working_dir:
            os.remove(filename)
        if in_index:
            os.remove(index_file_path)